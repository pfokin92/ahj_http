(()=>{"use strict";const t=new class{constructor(){this.widget=document.querySelector(".widget"),this.tasksList=document.querySelector(".tasks_list"),this.popUp=document.querySelector(".popup"),this.btnCancel=document.querySelector(".cancel"),this.btnOk=document.querySelector(".okeyBtn")}createTask(t,e,s,i){let n="";e&&(n+='<svg class="done" height="48" viewBox="0 0 48 48" width="48" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h48v48H0z" fill="none"/><path d="M36 14l-2.83-2.83-12.68 12.69 2.83 2.83L36 14zm8.49-2.83L23.31 32.34 14.97 24l-2.83 2.83L23.31 38l24-24-2.82-2.83zM.83 26.83L12 38l2.83-2.83L3.66 24 .83 26.83z"/></svg>');return`\n    <tr class="task" data-id="${t}">\n        <td class="status" data-id="${e}">\n            <p class="round">${n}</p>\n        </td>\n        <td class="text" data-id="name">${s}</td>\n        <td class="date" data-id="date">${i}</td>\n        <td class="change">\n            <p class="round edit-btn"><svg class="img edit" data-id="edit" height="48" viewBox="0 0 48 48" width="48" xmlns="http://www.w3.org/2000/svg"><path d="M6 34.5v7.5h7.5l22.13-22.13-7.5-7.5-22.13 22.13zm35.41-20.41c.78-.78.78-2.05 0-2.83l-4.67-4.67c-.78-.78-2.05-.78-2.83 0l-3.66 3.66 7.5 7.5 3.66-3.66z"/><path d="M0 0h48v48h-48z" fill="none"/></svg></p>\n        </td>\n        <td class="change">\n            <p class="round remove-btn"><svg class="img close" data-id="remove" height="48" viewBox="0 0 48 48" width="48" xmlns="http://www.w3.org/2000/svg"><path d="M38 12.83l-2.83-2.83-11.17 11.17-11.17-11.17-2.83 2.83 11.17 11.17-11.17 11.17 2.83 2.83 11.17-11.17 11.17 11.17 2.83-2.83-11.17-11.17z"/><path d="M0 0h48v48h-48z" fill="none"/></svg></p>\n        </td>\n    </tr>`}addPopUp(t,e,s,i,n,a){return`\n      <div class="content">\n          <h3 class="popover_header">${t}</h3>\n          <form class="form" name="${n}" data-id="${a}" data-idform="${i}" enctype="multipart/form-data">\n              <p class="name-new-ticket">Краткое описание</p>\n              <input class="input-name-new-ticket" name="title" data-id="name-edit" value="${e}">\n              <p class="description-new-ticket">Подробное описание</p>\n              <textarea class="input-description-new-ticket" name="description" data-id="description-edit">${s}</textarea>\n              <p class="btn_block">\n                  <a class="btn cancel">Отмена</a>\n                  <a class="btn okeyBtn">ОК</a>\n              </p>\n          </form>\n      </div>`}showDescription(t,e,s){return`\n    <div class="content">\n        <h3 class="popover_header">${t}</h3>\n          <p class="name-new-ticket">Краткое описание</p>\n          <p class="show-description" data-id="name-edit">${e}</p>\n          <p class="description-new-ticket">Подробное описание</p>\n          <p class="show-description" data-id="description-edit">${s}</p>\n          <p class="btn_block">\n              <a class="btn cancel">Закрыть</a>\n          </p>\n    </div>\n    `}showVertification(t,e){return`\n    <div class="content">\n        <h3 class="popover_header">Вы хотите удалить тикет <span class="show-name">${t}</span>?</h3>\n        <form class="form" action="submit" data-idform="${e}">\n          <p class="btn_block">\n              <a class="btn cancel">Нет</a>\n              <a class="btn okeyBtn">Да</a>\n          </p>\n        </form>\n    </div>\n    `}},e=new class{constructor(t){this.gui=t,this.tickets=null,this.url="https://ahj-http-server-pfokin.herokuapp.com",this.popUpReset=this.popUpReset.bind(this),this.popUpSubmit=this.popUpSubmit.bind(this),this.remove=this.remove.bind(this)}init(){this.getTickets(),this.gui.widget.addEventListener("click",(t=>{let e;t.preventDefault(),e="path"===t.target.tagName&&t.target.closest(".img")?t.target.closest(".img").dataset.id:t.target.dataset.id,"edit"===e?this.editTicket(t):"remove"===e?this.removeTicket(t):"name"===e?this.showDescription(t):"addTicket"===e&&this.addTicket(t)}))}async sendXHR(t,e,s){const i=new XMLHttpRequest;if("GET"===t){const s=`${this.url}?method=${e}`;i.open(t,s,!1),i.send()}else if("POST"===t){const n=`${this.url}?method=${s}`;i.open(t,n,!0),i.send(e)}else if("DELETE"===t){const s=`${this.url}?method=deleteTicket&id=${e}`;i.open(t,s,!1),i.send()}return i.responseText}async getTickets(){const t=JSON.parse(await this.sendXHR("GET","allTickets"));this.tickets=t,this.fillFields(this.tickets)}async popUpSubmit(t){t.preventDefault();const e=t.target.closest(".form"),s=e.querySelector(".input-name-new-ticket").value,i=e.querySelector(".input-description-new-ticket").value,n=e.dataset.idform;if("edit"===n){const{id:t}=e.dataset,n=new FormData;n.append("id",t),n.append("title",s),n.append("description",i),await this.sendXHR("POST",n,"editTicket")}else if("add"===n){const t=new FormData;t.append("title",s),t.append("description",i),await this.sendXHR("POST",t,"createTicket")}this.getTickets(),await this.gui.popUp.classList.add("hidden")}async remove(t){t.preventDefault();const e=t.target.closest(".form"),{id:s}=e.dataset,i=new FormData;i.append("id",s),await this.sendXHR("DELETE",i,""),await this.gui.popUp.classList.add("hidden"),this.getTickets()}popUpReset(t){t.preventDefault(),this.gui.popUp.classList.add("hidden")}async editTicket(t){t.preventDefault(),this.gui.popUp.innerHTML="";const e=t.target.closest(".task"),s=JSON.parse(await this.sendXHR("GET",`ticketById&id=${e.dataset.id}`));this.gui.popUp.classList.remove("hidden"),this.gui.popUp.innerHTML+=this.gui.addPopUp("Редактировать тикет",s.name,s.description,"edit",s.name,s.id);const i=this.gui.popUp.querySelector(".okeyBtn"),n=this.gui.popUp.querySelector(".cancel");i.addEventListener("click",this.popUpSubmit),n.addEventListener("click",this.popUpReset)}async removeTicket(t){t.preventDefault(),this.gui.popUp.innerHTML="";const e=t.target.closest(".task"),s=JSON.parse(await this.sendXHR("GET",`ticketById&id=${e.dataset.id}`));this.gui.popUp.classList.remove("hidden"),this.gui.popUp.innerHTML+=this.gui.showVertification(s.name,"remove");const i=this.gui.popUp.querySelector(".okeyBtn"),n=this.gui.popUp.querySelector(".cancel");i.addEventListener("click",this.remove),n.addEventListener("click",this.popUpReset)}async showDescription(t){t.preventDefault(),this.gui.popUp.innerHTML="";const e=t.target.closest(".task"),s=JSON.parse(await this.sendXHR("GET",`ticketById&id=${e.dataset.id}`));this.gui.popUp.classList.remove("hidden"),this.gui.popUp.innerHTML+=this.gui.showDescription("Тикет",s.name,s.description);this.gui.popUp.querySelector(".cancel").addEventListener("click",this.popUpReset)}addTicket(t){t.preventDefault(),this.gui.popUp.innerHTML="",this.gui.popUp.classList.remove("hidden"),this.gui.popUp.innerHTML+=this.gui.addPopUp("Добавить тикет","","","add","");const e=this.gui.popUp.querySelector(".okeyBtn"),s=this.gui.popUp.querySelector(".cancel");e.addEventListener("click",this.popUpSubmit),s.addEventListener("click",this.popUpReset)}fillFields(t){this.gui.tasksList.innerHTML="",t.forEach((t=>{this.gui.tasksList.innerHTML+=this.gui.createTask(t.id,t.status,t.name,t.created)}))}}(t);e.init()})();